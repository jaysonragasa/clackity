<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clackity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['Courier New', 'Courier', 'monospace'],
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for history table */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="transition-colors duration-300 bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 min-h-screen font-sans">

    <!-- Header -->
    <header class="px-6 py-4 flex items-center justify-between border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-2">
            <!-- Keyboard Icon -->
            <svg class="w-8 h-8 text-emerald-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2" ry="2"/><path d="M6 8h.001"/><path d="M10 8h.001"/><path d="M14 8h.001"/><path d="M18 8h.001"/><path d="M6 12h.001"/><path d="M10 12h.001"/><path d="M14 12h.001"/><path d="M18 12h.001"/><path d="M7 16h10"/></svg>
            <h1 class="text-xl font-bold tracking-tight">Clackity</h1>
        </div>
        <button id="theme-toggle" class="p-2 rounded-full transition-colors hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400">
            <!-- Sun Icon (Light Mode) -->
            <svg id="icon-sun" class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            <!-- Moon Icon (Dark Mode) -->
            <svg id="icon-moon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
        </button>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8 md:py-12">
        
        <!-- Difficulty Select -->
        <div class="flex justify-center mb-10">
            <div class="inline-flex rounded-lg p-1 bg-slate-200 dark:bg-slate-800">
                <button onclick="setDifficulty('easy')" id="btn-easy" class="px-6 py-2 rounded-md text-sm font-medium capitalize transition-all duration-200 text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white">easy</button>
                <button onclick="setDifficulty('medium')" id="btn-medium" class="px-6 py-2 rounded-md text-sm font-medium capitalize transition-all duration-200 bg-white text-slate-900 shadow-sm dark:bg-slate-700 dark:text-white">medium</button>
                <button onclick="setDifficulty('hard')" id="btn-hard" class="px-6 py-2 rounded-md text-sm font-medium capitalize transition-all duration-200 text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white">hard</button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <!-- Time -->
            <div id="card-time" class="p-4 rounded-xl border bg-white border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700 transition-colors">
                <div class="flex items-center gap-2 mb-2 text-slate-400 dark:text-slate-400">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span class="text-xs uppercase tracking-wider font-semibold">Time</span>
                </div>
                <div id="stat-time" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0:60</div>
            </div>

            <!-- WPM -->
            <div class="p-4 rounded-xl border bg-white border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700 transition-colors">
                <div class="flex items-center gap-2 mb-2 text-slate-400 dark:text-slate-400">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                    <span class="text-xs uppercase tracking-wider font-semibold">WPM</span>
                </div>
                <div id="stat-wpm" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</div>
            </div>

            <!-- Accuracy -->
            <div class="p-4 rounded-xl border bg-white border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700 transition-colors">
                <div class="flex items-center gap-2 mb-2 text-slate-400 dark:text-slate-400">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                    <span class="text-xs uppercase tracking-wider font-semibold">Accuracy</span>
                </div>
                <div id="stat-acc" class="text-2xl font-bold text-slate-800 dark:text-slate-100">100%</div>
            </div>

            <!-- Mistakes -->
            <div id="card-mistakes" class="p-4 rounded-xl border bg-white border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700 transition-colors">
                <div class="flex items-center gap-2 mb-2 text-slate-400 dark:text-slate-400" id="label-mistakes">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                    <span class="text-xs uppercase tracking-wider font-semibold">Mistakes</span>
                </div>
                <div id="stat-mistakes" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</div>
            </div>

            <!-- Status -->
            <div class="p-4 rounded-xl border bg-white border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700 transition-colors">
                <div class="flex items-center gap-2 mb-2 text-slate-400 dark:text-slate-400">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    <span class="text-xs uppercase tracking-wider font-semibold">Status</span>
                </div>
                <div id="stat-status" class="text-2xl font-bold text-slate-800 dark:text-slate-100">Ready</div>
            </div>
        </div>

        <!-- Typing Area Container -->
        <div class="relative mb-12">
            
            <!-- Game Active View -->
            <div id="game-view" class="relative rounded-xl p-8 min-h-[200px] cursor-text transition-colors bg-white shadow-sm border border-slate-200 dark:bg-slate-800/50 dark:border-slate-700">
                
                <!-- Start Overlay -->
                <div id="start-overlay" class="absolute inset-0 rounded-xl flex items-center justify-center bg-black/5 dark:bg-black/20 z-10 backdrop-blur-[1px] pointer-events-none transition-opacity duration-300">
                    <span class="text-lg font-medium text-slate-600 dark:text-slate-300">Start Typing to Begin</span>
                </div>

                <!-- Text Display -->
                <div class="relative">
                    <div id="text-display" class="leading-relaxed break-words select-none min-h-[100px] font-mono text-xl md:text-2xl">
                        <!-- Spans injected here via JS -->
                    </div>
                </div>

                <!-- Hidden Input -->
                <input id="hidden-input" type="text" class="absolute opacity-0 top-0 left-0 w-full h-full cursor-default" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            </div>

            <!-- Results View (Hidden by default) -->
            <div id="results-view" class="hidden rounded-xl p-8 text-center animate-fade-in bg-white shadow-lg border border-slate-100 dark:bg-slate-800 dark:border-none">
                <h2 class="text-3xl font-bold mb-6 text-slate-800 dark:text-slate-100">Test Complete!</h2>
                <div class="flex justify-center flex-wrap gap-8 mb-8">
                    <div class="text-center">
                        <div id="result-wpm" class="text-5xl font-bold text-emerald-500 mb-1">0</div>
                        <div class="text-sm text-slate-500 dark:text-slate-400">Words Per Min</div>
                    </div>
                    <div class="text-center">
                        <div id="result-acc" class="text-5xl font-bold mb-1">100%</div>
                        <div class="text-sm text-slate-500 dark:text-slate-400">Accuracy</div>
                    </div>
                    <div class="text-center">
                        <div id="result-mistakes" class="text-5xl font-bold text-red-500 mb-1">0</div>
                        <div class="text-sm text-slate-500 dark:text-slate-400">Mistakes</div>
                    </div>
                </div>
                <button onclick="resetGame()" class="inline-flex items-center gap-2 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold transition-colors shadow-lg shadow-emerald-600/20">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>
                    Try Again
                </button>
            </div>
        </div>

        <!-- History Section -->
        <div id="history-section" class="hidden animate-fade-in">
            <div class="flex items-center gap-2 mb-4">
                <svg class="w-5 h-5 text-slate-500 dark:text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>
                <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300">Recent History</h3>
            </div>
            <div class="rounded-xl overflow-hidden border bg-white border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 dark:bg-slate-900/50 dark:text-slate-400">
                            <tr>
                                <th class="px-6 py-3 font-medium">Date</th>
                                <th class="px-6 py-3 font-medium">Level</th>
                                <th class="px-6 py-3 font-medium">WPM</th>
                                <th class="px-6 py-3 font-medium">Accuracy</th>
                                <th class="px-6 py-3 font-medium">Mistakes</th>
                            </tr>
                        </thead>
                        <tbody id="history-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                            <!-- History rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Data ---
        const WORD_POOLS = {
            easy: [
                "the", "be", "to", "of", "and", "a", "in", "that", "have", "it", "for", "not", "on", "with", "he", "as", "you", "do", "at", "this", "but", "his", "by", "from", "they", "we", "say", "her", "she", "or", "an", "will", "my", "one", "all", "would", "there", "their", "what", "so", "up", "out", "if", "about", "who", "get", "which", "go", "me", "when", "make", "can", "like", "time", "no", "just", "him", "know", "take", "people", "into", "year", "your", "good", "some", "could", "them", "see", "other", "than", "then", "now", "look", "only", "come", "its", "over", "think", "also", "back", "after", "use", "two", "how", "our", "work", "first", "well", "way", "even", "new", "want", "because", "any", "these", "give", "day", "most", "us", "is", "are", "was", "were", "been", "has", "had", "may", "can", "should"
            ],
            medium: [
                "computer", "science", "keyboard", "monitor", "software", "program", "syntax", "mouse", "screen", "pixel", "coding", "java", "script", "python", "react", "html", "browser", "server", "client", "cloud", "data", "base", "logic", "error", "debug", "compile", "query", "model", "view", "router", "state", "effect", "hook", "class", "object", "array", "string", "number", "boolean", "import", "export", "module", "system", "memory", "storage", "network", "proxy", "token", "auth", "login", "user", "admin", "access", "public", "private", "static", "void", "return", "value", "input", "output", "stream", "buffer", "file", "folder", "drive", "disk", "media", "image", "audio", "video", "frame", "style", "font", "color", "width", "height", "margin", "padding", "border", "flex", "grid"
            ],
            hard: [
                "algorithm", "bandwidth", "capability", "dashboard", "encryption", "firewall", "gigabyte", "heuristic", "interface", "javascript", "kernel", "latency", "mainframe", "network", "operating", "protocol", "quantum", "runtime", "server", "terminal", "unicode", "virtual", "wireless", "xml", "yield", "zone", "abstraction", "polymorphism", "encapsulation", "inheritance", "recursion", "iteration", "complexity", "optimization", "parameter", "argument", "constructor", "destructor", "middleware", "framework", "library", "dependency", "repository", "version", "control", "asynchronous", "synchronous", "promise", "callback", "await", "fetch", "axios", "graphql", "restful", "endpoint", "controller", "service", "provider", "context", "reducer", "action", "dispatch", "selector", "middleware", "store", "component", "element", "fragment", "portal", "renderer", "hydration", "performance", "scalability", "maintainability", "reliability", "availability", "consistency", "isolation", "durability", "transaction", "constraint", "integrity", "normalization", "indexing", "partitioning", "sharding", "replication", "distribution", "synchronization", "concurrency", "parallelism", "multithreading", "processor", "architecture", "infrastructure", "deployment", "containerization", "virtualization", "orchestration", "microservices", "serverless", "computing", "artificial", "intelligence", "machine", "learning", "neural", "network", "deep", "reinforcement", "supervised", "unsupervised", "classification", "regression", "clustering", "dimensionality", "reduction", "feature", "engineering", "model", "training", "evaluation", "prediction", "inference"
            ]
        };

        const TIME_LIMITS = { easy: 30, medium: 60, hard: 60 };

        // --- State ---
        let state = {
            difficulty: 'medium',
            gameState: 'idle', // idle, playing, finished
            targetText: '',
            userInput: '',
            timeLeft: 60,
            startTime: null,
            timerId: null,
            wpm: 0,
            accuracy: 100,
            mistakes: 0,
            totalKeystrokes: 0, // Track every physical key press
            history: []
        };

        // --- Elements ---
        const els = {
            input: document.getElementById('hidden-input'),
            display: document.getElementById('text-display'),
            startOverlay: document.getElementById('start-overlay'),
            time: document.getElementById('stat-time'),
            cardTime: document.getElementById('card-time'),
            wpm: document.getElementById('stat-wpm'),
            acc: document.getElementById('stat-acc'),
            mistakes: document.getElementById('stat-mistakes'),
            cardMistakes: document.getElementById('card-mistakes'),
            labelMistakes: document.getElementById('label-mistakes'),
            status: document.getElementById('stat-status'),
            gameView: document.getElementById('game-view'),
            resultsView: document.getElementById('results-view'),
            resultWpm: document.getElementById('result-wpm'),
            resultAcc: document.getElementById('result-acc'),
            resultMistakes: document.getElementById('result-mistakes'),
            historySection: document.getElementById('history-section'),
            historyBody: document.getElementById('history-body'),
            themeToggle: document.getElementById('theme-toggle'),
            iconSun: document.getElementById('icon-sun'),
            iconMoon: document.getElementById('icon-moon'),
            btns: {
                easy: document.getElementById('btn-easy'),
                medium: document.getElementById('btn-medium'),
                hard: document.getElementById('btn-hard')
            }
        };

        // --- Init ---
        function init() {
            // Theme
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeIcons(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcons(false);
            }

            // History
            const saved = localStorage.getItem('typingHistory');
            if (saved) {
                state.history = JSON.parse(saved);
                renderHistory();
            }

            // Game
            setDifficulty('medium');

            // Listeners
            els.themeToggle.addEventListener('click', toggleTheme);
            els.input.addEventListener('input', handleInput);
            
            // KEYDOWN Listener for strict keystroke counting
            els.input.addEventListener('keydown', (e) => {
                if (state.gameState === 'finished') return;
                
                // If game hasn't started, first keypress starts it
                if (state.gameState === 'idle') {
                    // Start game logic is handled in handleInput usually, but we need to count this first key
                    // We'll let handleInput start the game state, but we count the key here if it's valid
                }

                // Count Backspace
                if (e.key === 'Backspace') {
                    state.totalKeystrokes++;
                } 
                // Count any single character key (excluding meta keys)
                else if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                    state.totalKeystrokes++;
                }
            });
            
            // Focus hack
            els.gameView.addEventListener('click', () => {
                if (state.gameState !== 'finished') els.input.focus();
            });
        }

        // --- Core Logic ---
        function generateText(diff) {
            const pool = WORD_POOLS[diff];
            const wordCount = diff === 'easy' ? 30 : diff === 'medium' ? 40 : 30;
            let words = [];
            for (let i = 0; i < wordCount; i++) {
                words.push(pool[Math.floor(Math.random() * pool.length)]);
            }

            if (diff === 'easy') return words.join(' ');

            let text = words.map((word, index) => {
                if (index === 0 || index % 8 === 0) return word.charAt(0).toUpperCase() + word.slice(1);
                if ((index + 1) % 8 === 0 && index !== words.length - 1) return word + ".";
                if (Math.random() > 0.85 && index !== words.length - 1 && (index + 1) % 8 !== 0) return word + ",";
                return word;
            }).join(' ');

            if (!text.endsWith('.')) text += '.';
            return text;
        }

        function setDifficulty(diff) {
            if (state.gameState === 'playing') return;
            state.difficulty = diff;
            
            // UI
            Object.keys(els.btns).forEach(key => {
                const btn = els.btns[key];
                
                // Reset basic styles
                btn.className = `px-6 py-2 rounded-md text-sm font-medium capitalize transition-all duration-200`;
                
                if (key === diff) {
                    btn.classList.add('shadow-sm');
                    if (document.documentElement.classList.contains('dark')) {
                        btn.classList.add('bg-slate-700', 'text-white');
                    } else {
                        btn.classList.add('bg-white', 'text-slate-900');
                    }
                } else {
                    if (document.documentElement.classList.contains('dark')) {
                        btn.classList.add('text-slate-400', 'hover:text-white');
                    } else {
                        btn.classList.add('text-slate-500', 'hover:text-slate-900');
                    }
                }
            });

            resetGame();
        }

        function resetGame() {
            state.gameState = 'idle';
            state.timeLeft = TIME_LIMITS[state.difficulty];
            state.targetText = generateText(state.difficulty);
            state.userInput = '';
            state.startTime = null;
            state.wpm = 0;
            state.accuracy = 100;
            state.mistakes = 0;
            state.totalKeystrokes = 0; // Reset total keystrokes

            if (state.timerId) clearInterval(state.timerId);
            
            els.input.value = '';
            els.input.focus();
            els.gameView.classList.remove('hidden');
            els.resultsView.classList.add('hidden');
            els.startOverlay.classList.remove('opacity-0');
            
            updateStatsUI();
            renderText();
        }

        function startGame() {
            state.gameState = 'playing';
            state.startTime = Date.now();
            els.startOverlay.classList.add('opacity-0');
            
            state.timerId = setInterval(() => {
                state.timeLeft--;
                updateStatsUI();
                if (state.timeLeft <= 0) {
                    finishGame();
                }
            }, 1000);
            updateStatsUI();
        }

        function finishGame() {
            state.gameState = 'finished';
            clearInterval(state.timerId);

            // Final calc
            calculateStats();
            updateStatsUI();

            // Save History
            const record = {
                date: new Date().toISOString(),
                difficulty: state.difficulty,
                wpm: state.wpm,
                accuracy: state.accuracy,
                mistakes: state.mistakes
            };
            state.history.unshift(record);
            if(state.history.length > 10) state.history.pop();
            localStorage.setItem('typingHistory', JSON.stringify(state.history));

            // Show Results
            els.gameView.classList.add('hidden');
            els.resultsView.classList.remove('hidden');
            
            els.resultWpm.textContent = state.wpm;
            
            // Acc color
            els.resultAcc.textContent = state.accuracy + '%';
            els.resultAcc.className = `text-5xl font-bold mb-1 ${state.accuracy >= 95 ? 'text-emerald-500' : state.accuracy >= 80 ? 'text-yellow-500' : 'text-red-500'}`;
            
            els.resultMistakes.textContent = state.mistakes;

            renderHistory();
        }

        function handleInput(e) {
            if (state.gameState === 'finished') return;
            if (state.gameState === 'idle') startGame();

            const newInput = e.target.value;
            
            // Mistake tracking (Cumulative for the counter): If user typed new chars
            if (newInput.length > state.userInput.length) {
                // Loop from the end of the OLD input to the end of the NEW input
                for (let i = state.userInput.length; i < newInput.length; i++) {
                    if (newInput[i] !== state.targetText[i]) {
                        state.mistakes++;
                    }
                }
            }

            state.userInput = newInput;
            calculateStats();
            updateStatsUI();
            renderText();

            if (state.userInput.length >= state.targetText.length) {
                finishGame();
            }
        }

        function calculateStats() {
            let correct = 0;
            const len = state.userInput.length;
            
            for(let i=0; i<len; i++) {
                if(state.userInput[i] === state.targetText[i]) correct++;
            }

            // Accuracy = (Correct Characters) / (Total Physical Keystrokes)
            // state.totalKeystrokes is updated via 'keydown' listener to capture Backspaces and all key presses
            state.accuracy = state.totalKeystrokes > 0 ? Math.round((correct / state.totalKeystrokes) * 100) : 100;

            let timeElapsed = 0;
            if (state.startTime) {
                timeElapsed = (Date.now() - state.startTime) / 1000;
            }
            if (state.gameState === 'finished') {
                timeElapsed = TIME_LIMITS[state.difficulty] - state.timeLeft;
                if(timeElapsed <= 0) timeElapsed = TIME_LIMITS[state.difficulty]; // Timeout case
            }

            if (timeElapsed > 0) {
                const words = correct / 5;
                const minutes = timeElapsed / 60;
                state.wpm = Math.round(words / minutes);
            } else {
                state.wpm = 0;
            }
        }

        // --- Renderers ---
        function updateStatsUI() {
            // Time
            const mins = Math.floor(state.timeLeft / 60);
            const secs = state.timeLeft % 60;
            els.time.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            // Red alert for low time
            if (state.timeLeft < 10 && state.gameState === 'playing') {
                els.cardTime.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                els.time.classList.add('text-red-600');
            } else {
                els.cardTime.classList.remove('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                els.time.classList.remove('text-red-600');
            }

            // Stats
            els.wpm.textContent = state.wpm;
            els.acc.textContent = state.accuracy + '%';
            els.mistakes.textContent = state.mistakes;

            // Mistakes alert
            if (state.mistakes > 0) {
                els.cardMistakes.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                els.mistakes.classList.add('text-red-600');
                els.labelMistakes.classList.add('text-red-600');
            } else {
                els.cardMistakes.classList.remove('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                els.mistakes.classList.remove('text-red-600');
                els.labelMistakes.classList.remove('text-red-600');
            }

            els.status.textContent = state.gameState === 'idle' ? 'Ready' : state.gameState === 'playing' ? 'Typing...' : 'Done';
        }

        function renderText() {
            const display = els.display;
            display.innerHTML = '';
            
            const chars = state.targetText.split('');
            const inputLen = state.userInput.length;

            chars.forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char;
                span.className = 'relative font-mono text-xl md:text-2xl transition-colors duration-75 ';

                if (index < inputLen) {
                    if (state.userInput[index] === char) {
                        span.className += 'text-emerald-600 dark:text-emerald-400';
                    } else {
                        span.className += 'text-red-500 bg-red-100 dark:bg-red-500/10';
                    }
                } else {
                    span.className += 'text-slate-300 dark:text-slate-600';
                }

                // Cursor
                if (index === inputLen) {
                    const cursor = document.createElement('span');
                    cursor.className = 'absolute -left-[1px] top-0 bottom-0 w-[2px] animate-pulse-fast bg-emerald-600 dark:bg-emerald-400';
                    span.appendChild(cursor);
                }

                display.appendChild(span);
            });
        }

        function renderHistory() {
            if (state.history.length === 0) {
                els.historySection.classList.add('hidden');
                return;
            }
            els.historySection.classList.remove('hidden');
            els.historyBody.innerHTML = '';

            state.history.forEach(run => {
                const tr = document.createElement('tr');
                tr.className = 'transition-colors hover:bg-slate-50 dark:hover:bg-slate-700/30';
                
                const date = new Date(run.date).toLocaleDateString();
                
                // Badge color
                let badgeClass = '';
                if(run.difficulty === 'easy') badgeClass = 'bg-green-100 text-green-700 dark:bg-green-500/10 dark:text-green-400';
                else if(run.difficulty === 'medium') badgeClass = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-500/10 dark:text-yellow-400';
                else badgeClass = 'bg-red-100 text-red-700 dark:bg-red-500/10 dark:text-red-400';

                tr.innerHTML = `
                    <td class="px-6 py-3 whitespace-nowrap text-slate-600 dark:text-slate-400">${date}</td>
                    <td class="px-6 py-3 capitalize"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${badgeClass}">${run.difficulty}</span></td>
                    <td class="px-6 py-3 font-semibold text-emerald-600 dark:text-emerald-400">${run.wpm}</td>
                    <td class="px-6 py-3 text-slate-600 dark:text-slate-300">${run.accuracy}%</td>
                    <td class="px-6 py-3 text-slate-500 dark:text-slate-400">${run.mistakes || 0}</td>
                `;
                els.historyBody.appendChild(tr);
            });
        }

        // --- Utils ---
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                updateThemeIcons(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                updateThemeIcons(true);
            }
            // Re-render to fix difficulty button colors
            setDifficulty(state.difficulty);
        }

        function updateThemeIcons(isDark) {
            if (isDark) {
                els.iconSun.classList.remove('hidden');
                els.iconMoon.classList.add('hidden');
            } else {
                els.iconSun.classList.add('hidden');
                els.iconMoon.classList.remove('hidden');
            }
        }

        // Start
        init();

    </script>
</body>
</html>
